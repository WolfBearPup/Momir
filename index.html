<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Summon a Creature (CMC 1–20)</title>

  <style>
    :root{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color-scheme: dark;
      --bg0:#06070a;
      --bg1:#0b0c10;
      --glass: rgba(255,255,255,0.07);
      --glass2: rgba(255,255,255,0.10);
      --stroke: rgba(255,255,255,0.16);
      --stroke2: rgba(255,255,255,0.26);
      --accent: rgba(62,95,255,0.75);
      --warn: rgba(224,47,31,0.95);
      --text: rgba(255,255,255,0.96);
      --muted: rgba(255,255,255,0.72);
      --muted2: rgba(255,255,255,0.58);
      --radius-lg: 18px;
      --radius-md: 14px;
      --radius-sm: 12px;
      --shadow: 0 18px 40px rgba(0,0,0,0.55);
    }

    html, body { height: 100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 50% 25%, rgba(62,95,255,0.22), rgba(0,0,0,0) 60%),
                  radial-gradient(900px 600px at 20% 75%, rgba(250,201,0,0.10), rgba(0,0,0,0) 55%),
                  linear-gradient(var(--bg0), var(--bg1));
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      overflow: hidden;
      touch-action: manipulation;
    }

    /* Safe-area helpers (iPhone notch/home indicator) */
    .safePad {
      padding-top: calc(14px + env(safe-area-inset-top));
      padding-right: calc(14px + env(safe-area-inset-right));
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      padding-left: calc(14px + env(safe-area-inset-left));
    }

    /* ---------- Overlay (full-screen number picker) ---------- */
    .overlay{
      position: fixed;
      inset: 0;
      z-index: 10;
      min-height: 100svh; /* better on iOS than 100vh */
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap: 14px;
      transition: opacity 360ms ease, transform 360ms ease;
      will-change: opacity, transform;
    }
    .overlay.hidden{
      opacity:0;
      pointer-events:none;
      transform: scale(1.02);
    }

    .header{
      text-align:center;
      margin: 0 auto;
      max-width: 520px;
    }
    .title{
      margin:0;
      font-size: 22px;
      font-weight: 900;
      letter-spacing: 0.2px;
    }
    .subtitle{
      margin: 6px 0 0;
      font-size: 13px;
      color: var(--muted);
      line-height: 1.35;
    }
    .hint{
      margin: 8px 0 0;
      font-size: 12px;
      color: var(--muted2);
      line-height: 1.35;
    }
    .hint .warnWord{
      color: var(--warn);
      font-weight: 900;
      letter-spacing: 0.2px;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr); /* 4x5 on iPhone */
      gap: 12px;
      width: 100%;
      max-width: 520px;
      margin: 6px auto 0;
    }

    .grid button{
      appearance:none;
      border: 1px solid var(--stroke);
      background: var(--glass);
      color: var(--text);
      border-radius: 16px;
      height: 72px;                 /* comfy tap target on iPhone */
      font-size: clamp(24px, 6vw, 36px);
      font-weight: 950;
      letter-spacing: 0.6px;
      backdrop-filter: blur(8px);
      -webkit-tap-highlight-color: transparent;
      transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
      box-shadow: 0 10px 20px rgba(0,0,0,0.25);
      user-select: none;
    }
    .grid button:active{
      transform: scale(0.97);
      background: var(--glass2);
      border-color: var(--stroke2);
    }

    /* Red tint for MVs that have no results (auto-updated) */
    .grid button.noResult{
      background: rgba(224,47,31,0.11);
      border-color: rgba(224,47,31,0.40);
      box-shadow: 0 10px 20px rgba(224,47,31,0.08), 0 10px 20px rgba(0,0,0,0.25);
    }

    .footerNote{
      text-align:center;
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted2);
    }

    /* ---------- Stage (dramatic reveal) ---------- */
    .stage{
      position: fixed;
      inset: 0;
      z-index: 1;
      min-height: 100svh;
      display:flex;
      justify-content:center;
      align-items: stretch;
      opacity:0;
      transform: translateY(18px);
      transition: opacity 360ms ease, transform 360ms ease;
      will-change: opacity, transform;
    }
    .stage.visible{
      opacity:1;
      transform: translateY(0);
    }

    .panel{
      width: 100%;
      max-width: 430px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: var(--glass);
      backdrop-filter: blur(8px);
      font-size: 13px;
      font-weight: 850;
      color: var(--text);
      opacity: 0.96;
      user-select:none;
    }

    .btn{
      appearance:none;
      border: 1px solid var(--stroke);
      background: var(--glass);
      color: var(--text);
      border-radius: 14px;
      padding: 11px 12px;
      font-size: 13px;
      font-weight: 900;
      -webkit-tap-highlight-color: transparent;
      transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
      white-space: nowrap;
      user-select:none;
    }
    .btn:active{
      transform: scale(0.98);
      background: var(--glass2);
      border-color: var(--stroke2);
    }

    .cardWrap{
      flex: 1;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap: 10px;
    }

    .meta{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
    }

    .name{
      font-size: 16px;
      font-weight: 950;
      letter-spacing: 0.2px;
      line-height: 1.15;
    }
    .mv{
      font-size: 13px;
      color: var(--muted);
      white-space: nowrap;
      font-weight: 850;
    }

    .imgFrame{
      border-radius: var(--radius-lg);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      box-shadow: var(--shadow);
      /* Keep it within iPhone screen */
      max-height: 70svh;
      aspect-ratio: 63 / 88; /* MTG-ish ratio */
    }

    img{
      width: 100%;
      height: 100%;
      display:block;
      object-fit: contain;
      transform-origin: 50% 60%;
    }

    /* Reveal animation */
    .reveal{
      animation: reveal 720ms cubic-bezier(.16,.84,.27,1) both;
    }
    @keyframes reveal{
      0%{
        opacity:0;
        transform: scale(0.86) rotate(-2deg);
        filter: blur(16px) brightness(0.75);
      }
      60%{
        opacity:1;
        transform: scale(1.02) rotate(0.4deg);
        filter: blur(2px) brightness(1);
      }
      100%{
        opacity:1;
        transform: scale(1) rotate(0deg);
        filter:none;
      }
    }

    /* Loading shimmer */
    .loadingFrame{
      position: relative;
      width: 100%;
      height: 100%;
      min-height: 320px;
    }
    .loadingFrame::before{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(110deg,
        rgba(255,255,255,0.02),
        rgba(255,255,255,0.10),
        rgba(255,255,255,0.02)
      );
      transform: translateX(-60%);
      animation: shimmer 1.15s ease-in-out infinite;
    }
    @keyframes shimmer{
      0%   { transform: translateX(-60%); opacity: 0.55; }
      50%  { opacity: 0.95; }
      100% { transform: translateX(60%);  opacity: 0.55; }
    }

    .status{
      font-size: 13px;
      color: var(--muted);
      line-height: 1.35;
    }

    a{
      color: rgba(140,174,248,0.98);
      text-decoration:none;
      font-weight: 900;
    }

    @media (prefers-reduced-motion: reduce){
      .overlay, .stage { transition: none; }
      .reveal { animation: none; }
      .loadingFrame::before { animation: none; }
    }

    /* Small phones: tighten spacing a bit */
    @media (max-height: 720px){
      .grid button{ height: 66px; }
      .imgFrame{ max-height: 66svh; }
      .title{ font-size: 20px; }
    }

    /* =========================
       History (minimal style additions)
       ========================= */

    .historyTab{
      position: fixed;
      left: calc(14px + env(safe-area-inset-left));
      right: calc(14px + env(safe-area-inset-right));
      bottom: calc(12px + env(safe-area-inset-bottom));
      z-index: 12; /* above overlay content */
      width: auto;
      display:flex;
      justify-content:center;
      pointer-events:auto;
      transition: opacity 220ms ease, transform 220ms ease;
      will-change: opacity, transform;
    }
    .historyTab.hidden{
      opacity:0;
      pointer-events:none;
      transform: translateY(10px);
    }
    .historyTab button{
      width: 100%;
      max-width: 520px;
      border: 1px solid var(--stroke);
      background: var(--glass);
      color: var(--text);
      border-radius: 999px;
      padding: 12px 14px;
      font-size: 13px;
      font-weight: 950;
      letter-spacing: 0.2px;
      backdrop-filter: blur(8px);
      -webkit-tap-highlight-color: transparent;
      box-shadow: 0 12px 22px rgba(0,0,0,0.28);
      user-select:none;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
    }
    .historyTab button:active{
      transform: scale(0.985);
      background: var(--glass2);
      border-color: var(--stroke2);
    }

    .historyOverlay{
      position: fixed;
      inset: 0;
      z-index: 30;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding-right: calc(14px + env(safe-area-inset-right));
      padding-left: calc(14px + env(safe-area-inset-left));
      padding-bottom: calc(14px + env(safe-area-inset-bottom));
      padding-top: calc(14px + env(safe-area-inset-top));
      background: rgba(0,0,0,0.35);
      backdrop-filter: blur(10px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 220ms ease;
      will-change: opacity;
    }
    .historyOverlay.open{
      opacity:1;
      pointer-events:auto;
    }

    .historySheet{
      width: 100%;
      max-width: 520px;
      max-height: 86svh;
      border-radius: 22px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.06);
      box-shadow: var(--shadow);
      overflow:hidden;
      transform: translateY(16px);
      transition: transform 260ms cubic-bezier(.16,.84,.27,1);
      will-change: transform;
    }
    .historyOverlay.open .historySheet{
      transform: translateY(0);
    }

    .historyHeader{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
    }
    .historyHeader .hTitle{
      font-size: 14px;
      font-weight: 950;
      letter-spacing: 0.2px;
      color: var(--text);
    }
    .historyHeader .hSub{
      font-size: 12px;
      color: var(--muted2);
      font-weight: 850;
      margin-top: 2px;
    }
    .historyHeader .hLeft{
      display:flex;
      flex-direction:column;
      gap: 0;
    }
    .historyHeader .hClose{
      padding: 10px 12px;
      border-radius: 999px;
    }

    .historyList{
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap: 12px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      max-height: calc(86svh - 54px);
    }

    .historyEmpty{
      padding: 24px 6px 10px;
      text-align:center;
      color: var(--muted2);
      font-size: 13px;
      line-height: 1.35;
    }

    .historyItem{
      border-radius: var(--radius-lg);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      box-shadow: 0 14px 26px rgba(0,0,0,0.35);
    }
    .historyItem .imgFrame{
      max-height: 56svh; /* slightly smaller than main stage */
      box-shadow: none;
      border: none;
      border-radius: 0;
      background: rgba(255,255,255,0.03);
    }
    .historyMetaRow{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px 12px;
    }
    .historyMetaRow .hName{
      font-size: 13px;
      font-weight: 950;
      color: var(--text);
      line-height: 1.2;
      flex: 1;
      min-width: 0;
    }
    .historyMetaRow .hRight{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap: 4px;
      flex-shrink:0;
    }
    .historyMetaRow .hMv{
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      white-space: nowrap;
    }
    .historyMetaRow .hLink{
      font-size: 12px;
      color: rgba(140,174,248,0.98);
      font-weight: 900;
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <!-- Full-screen number overlay -->
  <section id="overlay" class="overlay safePad" aria-label="CMC number overlay">
    <div class="header">
      <h1 class="title">Choose a CMC to Summon</h1>
      <p class="subtitle">Tap 1–20 to pull a random creature with that mana value.</p>
      <p class="hint"><span class="warnWord">Red-tinted</span> numbers have no matching creatures.</p>
    </div>

    <div id="cmcGrid" class="grid" role="group" aria-label="CMC buttons"></div>

    <div class="footerNote">Tip: tap anywhere on the card to return to numbers.</div>
  </section>

  <!-- History Tab -->
  <div id="historyTab" class="historyTab">
    <button type="button" id="historyBtn" aria-haspopup="dialog" aria-controls="historyOverlay">
      History
    </button>
  </div>

  <!-- History Bottom Sheet -->
  <div id="historyOverlay" class="historyOverlay" role="dialog" aria-modal="true" aria-label="History">
    <div class="historySheet" role="document">
      <div class="historyHeader">
        <div class="hLeft">
          <div class="hTitle">History</div>
          <div class="hSub">Previously summoned creatures</div>
        </div>
        <button id="historyClose" class="btn hClose" type="button">Close</button>
      </div>
      <div id="historyList" class="historyList"></div>
    </div>
  </div>

  <!-- Card stage -->
  <main id="stage" class="stage safePad" aria-live="polite">
    <div class="panel">
      <div class="topbar">
        <button id="backBtn" class="btn" type="button">Pick another</button>
        <div id="cmcPill" class="pill">CMC: —</div>
      </div>

      <div class="cardWrap">
        <div class="meta">
          <div id="cardName" class="name">Waiting…</div>
          <div id="cardMV" class="mv"></div>
        </div>

        <div class="imgFrame" id="frame">
          <div id="loadingShell" class="loadingFrame" style="display:none;"></div>
          <img id="cardImg" alt="" />
        </div>

        <div id="statusLine" class="status"></div>
        <div class="status">
          <a id="scryfallLink" href="#" target="_blank" rel="noopener noreferrer" style="display:none;">
            View on Scryfall
          </a>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Scryfall endpoints
    const scryfallRandomURI = "https://api.scryfall.com/cards/random?format=json&q=";
    const scryfallSearchURI = "https://api.scryfall.com/cards/search?order=released&unique=cards&q=";

    // Front-face creature only:
    // t:/^[^\/]*Creature/
    // (encoded) t%3A%2F%5E%5B%5E%5C%2F%5D*Creature%2F+
    const creatureQuery = "t%3A%2F%5E%5B%5E%5C%2F%5D*Creature%2F+";

    // Keep your original filters + mv=
    const genericQuery  = "(game%3Apaper)+lang%3Aenglish+(-is%3Afunny)+is%3Afirstprinting+F%3AV+-o%3Adraft+mv%3D";

    let inFlight = false;
    let buttonsByMV = {};

    // Cache availability checks to avoid 20 API hits on every load (24h TTL)
    const AVAIL_CACHE_KEY = "mvCreatureAvailability_v1";
    const AVAIL_CACHE_TTL_MS = 24 * 60 * 60 * 1000;

    // History
    const HISTORY_KEY = "mvCreatureHistory_v1";
    const HISTORY_MAX = 60;

    async function fetchNewCard(url) {
      const response = await fetch(url);

      const text = await response.text();
      let data = null;
      try { data = JSON.parse(text); } catch {}

      if (!response.ok) {
        throw new Error(data?.details ?? `Scryfall error: ${response.status}`);
      }
      return data;
    }

    function getImageUrl(card) {
      if (card?.image_uris?.border_crop) return card.image_uris.border_crop;

      const face = card?.card_faces?.find(f => f?.image_uris?.border_crop);
      if (face) return face.image_uris.border_crop;

      if (card?.image_uris?.normal) return card.image_uris.normal;
      const face2 = card?.card_faces?.find(f => f?.image_uris?.normal);
      if (face2) return face2.image_uris.normal;

      return "";
    }

    function buildCreatureRandomUrl(mv) {
      const t = Date.now();
      return scryfallRandomURI + creatureQuery + genericQuery + mv + "&t=" + t;
    }

    function buildCreatureSearchUrl(mv) {
      const t = Date.now();
      return scryfallSearchURI + creatureQuery + genericQuery + mv + "&t=" + t;
    }

    /* ---------- Auto-style buttons (no results) ---------- */

    function createLimiter(maxConcurrent) {
      let active = 0;
      const queue = [];
      return (fn) => new Promise((resolve, reject) => {
        const run = async () => {
          active++;
          try { resolve(await fn()); }
          catch (e) { reject(e); }
          finally {
            active--;
            if (queue.length) queue.shift()();
          }
        };
        if (active < maxConcurrent) run();
        else queue.push(run);
      });
    }
    const limit = createLimiter(4);

    // Returns: true (has results), false (no results), null (unknown/error)
    async function hasCreatureForMV(mv) {
      const url = buildCreatureSearchUrl(mv);
      const res = await fetch(url);

      // /cards/search returns 404 when nothing matches
      if (res.status === 404) return false;
      if (!res.ok) return null;

      const data = await res.json().catch(() => null);
      const total = data?.total_cards;
      if (typeof total === "number") return total > 0;

      return Array.isArray(data?.data) && data.data.length > 0;
    }

    function applyNoResultStyles(availabilityMap) {
      for (const [mvStr, btn] of Object.entries(buttonsByMV)) {
        const mv = Number(mvStr);
        const available = availabilityMap[mv];
        if (available === false) btn.classList.add("noResult");
        else btn.classList.remove("noResult");
      }
    }

    async function refreshNoResultButtons() {
      const now = Date.now();

      // 1) Try cache
      try {
        const cached = JSON.parse(localStorage.getItem(AVAIL_CACHE_KEY) || "null");
        if (cached?.timestamp && cached?.map && (now - cached.timestamp) < AVAIL_CACHE_TTL_MS) {
          applyNoResultStyles(cached.map);
          return;
        }
      } catch {}

      // 2) Live check
      const map = {};
      const mvs = Object.keys(buttonsByMV).map(Number);

      await Promise.all(
        mvs.map(mv => limit(async () => {
          try { map[mv] = await hasCreatureForMV(mv); }
          catch { map[mv] = null; } // don't tint on network issues
        }))
      );

      applyNoResultStyles(map);

      // 3) Store cache
      try {
        localStorage.setItem(AVAIL_CACHE_KEY, JSON.stringify({ timestamp: now, map }));
      } catch {}
    }

    /* ---------- History ---------- */

    function loadHistory() {
      try {
        const raw = localStorage.getItem(HISTORY_KEY);
        const arr = JSON.parse(raw || "[]");
        return Array.isArray(arr) ? arr : [];
      } catch {
        return [];
      }
    }

    function saveHistory(arr) {
      try { localStorage.setItem(HISTORY_KEY, JSON.stringify(arr)); } catch {}
    }

    function addToHistory(card, chosenMV) {
      const img = getImageUrl(card);
      const entry = {
        t: Date.now(),
        chosenMV: chosenMV,
        name: card?.name ?? "Unknown card",
        uri: card?.scryfall_uri ?? "",
        img: img ?? "",
        id: card?.id ?? ""
      };

      const hist = loadHistory();
      hist.unshift(entry);
      if (hist.length > HISTORY_MAX) hist.length = HISTORY_MAX;

      saveHistory(hist);
      renderHistory();
    }

    function formatTime(ts) {
      try {
        const d = new Date(ts);
        return d.toLocaleString([], { month:"short", day:"numeric", hour:"numeric", minute:"2-digit" });
      } catch {
        return "";
      }
    }

    function renderHistory() {
      const list = document.getElementById("historyList");
      const hist = loadHistory();
      list.innerHTML = "";

      if (!hist.length) {
        const empty = document.createElement("div");
        empty.className = "historyEmpty";
        empty.textContent = "No creatures yet. Summon a card, then come back here to see it.";
        list.appendChild(empty);
        return;
      }

      for (const item of hist) {
        const wrap = document.createElement("div");
        wrap.className = "historyItem";

        const frame = document.createElement("div");
        frame.className = "imgFrame";

        const link = document.createElement("a");
        link.href = item.uri || "#";
        link.target = "_blank";
        link.rel = "noopener noreferrer";
        link.style.display = "block";

        const img = document.createElement("img");
        img.alt = item.name || "MTG card";
        img.loading = "lazy";
        img.decoding = "async";
        if (item.img) img.src = item.img;

        link.appendChild(img);
        frame.appendChild(link);

        const meta = document.createElement("div");
        meta.className = "historyMetaRow";

        const name = document.createElement("div");
        name.className = "hName";
        name.textContent = item.name || "Unknown card";

        const right = document.createElement("div");
        right.className = "hRight";

        const mv = document.createElement("div");
        mv.className = "hMv";
        mv.textContent = `CMC ${item.chosenMV}`;

        const a = document.createElement("a");
        a.className = "hLink";
        a.href = item.uri || "#";
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.textContent = formatTime(item.t);

        right.appendChild(mv);
        right.appendChild(a);

        meta.appendChild(name);
        meta.appendChild(right);

        wrap.appendChild(frame);
        wrap.appendChild(meta);

        list.appendChild(wrap);
      }
    }

    function openHistory() {
      renderHistory();
      document.getElementById("historyOverlay").classList.add("open");
    }

    function closeHistory() {
      document.getElementById("historyOverlay").classList.remove("open");
    }

    function setHistoryTabVisible(visible) {
      document.getElementById("historyTab").classList.toggle("hidden", !visible);
    }

    /* ---------- UI transitions ---------- */

    function showOverlay() {
      document.getElementById("overlay").classList.remove("hidden");
      document.getElementById("stage").classList.remove("visible");
      document.getElementById("statusLine").textContent = "";
      setHistoryTabVisible(true);
      closeHistory();
      refreshNoResultButtons();
    }

    function showStage() {
      document.getElementById("overlay").classList.add("hidden");
      document.getElementById("stage").classList.add("visible");
      setHistoryTabVisible(false);
      closeHistory();
    }

    /* ---------- Summon flow ---------- */

    async function summonCreature(mv) {
      if (inFlight) return;
      inFlight = true;

      const status = document.getElementById("statusLine");
      const img = document.getElementById("cardImg");
      const nameEl = document.getElementById("cardName");
      const mvEl = document.getElementById("cardMV");
      const linkEl = document.getElementById("scryfallLink");
      const cmcPill = document.getElementById("cmcPill");
      const loadingShell = document.getElementById("loadingShell");

      showStage();

      cmcPill.textContent = "CMC: " + mv;
      nameEl.textContent = "Summoning…";
      mvEl.textContent = "";
      linkEl.style.display = "none";
      status.textContent = "Searching for a creature with MV " + mv + "…";

      img.classList.remove("reveal");
      img.onload = null;
      img.removeAttribute("src");
      img.alt = "";

      loadingShell.style.display = "block";

      try {
        const card = await fetchNewCard(buildCreatureRandomUrl(mv));
        const imageUrl = getImageUrl(card);
        const displayedMV = (card?.mana_value ?? card?.cmc);

        nameEl.textContent = card?.name ?? "Unknown card";
        mvEl.textContent = (displayedMV != null) ? ("MV " + displayedMV) : "";

        if (card?.scryfall_uri) {
          linkEl.href = card.scryfall_uri;
          linkEl.style.display = "inline";
        }

        if (!imageUrl) {
          loadingShell.style.display = "none";
          status.textContent = "Pulled: " + (card?.name ?? "Unknown") + " (no image for this layout)";
          addToHistory(card, mv);
          return;
        }

        img.onload = () => {
          loadingShell.style.display = "none";
          void img.offsetWidth;
          img.classList.add("reveal");
        };

        img.src = imageUrl;
        img.alt = card?.name ?? "MTG card";
        status.textContent = "Pulled: " + (card?.name ?? "Unknown");

        addToHistory(card, mv);

      } catch (err) {
        loadingShell.style.display = "none";
        nameEl.textContent = "No card found";
        mvEl.textContent = "";
        status.textContent = "No result: " + (err?.message ?? String(err)) + " — try another number.";
      } finally {
        inFlight = false;
      }
    }

    function init() {
      const grid = document.getElementById("cmcGrid");
      const backBtn = document.getElementById("backBtn");
      const stage = document.getElementById("stage");

      const historyBtn = document.getElementById("historyBtn");
      const historyClose = document.getElementById("historyClose");
      const historyOverlay = document.getElementById("historyOverlay");

      buttonsByMV = {};

      for (let i = 1; i <= 20; i++) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = String(i);
        btn.addEventListener("click", () => summonCreature(i));
        grid.appendChild(btn);
        buttonsByMV[i] = btn;
      }

      // Back button still works
      backBtn.addEventListener("click", showOverlay);

      // ✅ Tap anywhere on the card screen to return (but don't steal taps on buttons/links)
      stage.addEventListener("pointerup", (e) => {
        if (!stage.classList.contains("visible")) return;
        if (e.target.closest("a, button")) return;
        showOverlay();
      });

      // History wiring
      historyBtn.addEventListener("click", openHistory);
      historyClose.addEventListener("click", closeHistory);

      // Tap outside the sheet to close
      historyOverlay.addEventListener("click", (e) => {
        if (e.target === historyOverlay) closeHistory();
      });

      showOverlay();
      refreshNoResultButtons();
      renderHistory();
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
