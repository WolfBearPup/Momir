<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Summon a Creature (CMC 1–20)</title>

  <style>
    :root{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color-scheme: dark;
      --bg0:#06070a;
      --bg1:#0b0c10;
      --glass: rgba(255,255,255,0.07);
      --glass2: rgba(255,255,255,0.10);
      --stroke: rgba(255,255,255,0.16);
      --stroke2: rgba(255,255,255,0.26);
      --accent: rgba(62,95,255,0.75);
      --warn: rgba(224,47,31,0.95);
      --text: rgba(255,255,255,0.96);
      --muted: rgba(255,255,255,0.72);
      --muted2: rgba(255,255,255,0.58);
      --radius-lg: 18px;
      --radius-md: 14px;
      --radius-sm: 12px;
      --shadow: 0 18px 40px rgba(0,0,0,0.55);
    }

    html, body { height: 100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 50% 25%, rgba(62,95,255,0.22), rgba(0,0,0,0) 60%),
                  radial-gradient(900px 600px at 20% 75%, rgba(250,201,0,0.10), rgba(0,0,0,0) 55%),
                  linear-gradient(var(--bg0), var(--bg1));
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      overflow: hidden;
      touch-action: manipulation;
    }

    /* Safe-area helpers (iPhone notch/home indicator) */
    .safePad {
      padding-top: calc(14px + env(safe-area-inset-top));
      padding-right: calc(14px + env(safe-area-inset-right));
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      padding-left: calc(14px + env(safe-area-inset-left));
    }

    /* ---------- Overlay (full-screen number picker) ---------- */
    .overlay{
      position: fixed;
      inset: 0;
      z-index: 10;
      min-height: 100svh; /* better on iOS than 100vh */
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap: 14px;
      transition: opacity 360ms ease, transform 360ms ease;
      will-change: opacity, transform;
    }
    .overlay.hidden{
      opacity:0;
      pointer-events:none;
      transform: scale(1.02);
    }

    .header{
      text-align:center;
      margin: 0 auto;
      max-width: 520px;
    }
    .title{
      margin:0;
      font-size: 22px;
      font-weight: 900;
      letter-spacing: 0.2px;
    }
    .subtitle{
      margin: 6px 0 0;
      font-size: 13px;
      color: var(--muted);
      line-height: 1.35;
    }
    .hint{
      margin: 8px 0 0;
      font-size: 12px;
      color: var(--muted2);
      line-height: 1.35;
    }
    .hint .warnWord{
      color: var(--warn);
      font-weight: 900;
      letter-spacing: 0.2px;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr); /* 4x5 on iPhone */
      gap: 12px;
      width: 100%;
      max-width: 520px;
      margin: 6px auto 0;
    }

    .grid button{
      appearance:none;
      border: 1px solid var(--stroke);
      background: var(--glass);
      color: var(--text);
      border-radius: 16px;
      height: 72px;                 /* comfy tap target on iPhone */
      font-size: clamp(24px, 6vw, 36px);
      font-weight: 950;
      letter-spacing: 0.6px;
      backdrop-filter: blur(8px);
      -webkit-tap-highlight-color: transparent;
      transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
      box-shadow: 0 10px 20px rgba(0,0,0,0.25);
      user-select: none;
    }
    .grid button:active{
      transform: scale(0.97);
      background: var(--glass2);
      border-color: var(--stroke2);
    }

    /* Red tint for MVs that have no results (auto-updated) */
    .grid button.noResult{
      background: rgba(224,47,31,0.11);
      border-color: rgba(224,47,31,0.40);
      box-shadow: 0 10px 20px rgba(224,47,31,0.08), 0 10px 20px rgba(0,0,0,0.25);
    }

    .footerNote{
      text-align:center;
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted2);
    }

    /* ---------- Stage (dramatic reveal) ---------- */
    .stage{
      position: fixed;
      inset: 0;
      z-index: 1;
      min-height: 100svh;
      display:flex;
      justify-content:center;
      align-items: stretch;
      opacity:0;
      transform: translateY(18px);
      transition: opacity 360ms ease, transform 360ms ease;
      will-change: opacity, transform;
    }
    .stage.visible{
      opacity:1;
      transform: translateY(0);
    }

    .panel{
      width: 100%;
      max-width: 430px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: var(--glass);
      backdrop-filter: blur(8px);
      font-size: 13px;
      font-weight: 850;
      color: var(--text);
      opacity: 0.96;
      user-select:none;
    }

    .btn{
      appearance:none;
      border: 1px solid var(--stroke);
      background: var(--glass);
      color: var(--text);
      border-radius: 14px;
      padding: 11px 12px;
      font-size: 13px;
      font-weight: 900;
      -webkit-tap-highlight-color: transparent;
      transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
      white-space: nowrap;
      user-select:none;
    }
    .btn:active{
      transform: scale(0.98);
      background: var(--glass2);
      border-color: var(--stroke2);
    }

    .cardWrap{
      flex: 1;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap: 10px;
    }

    .meta{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
    }

    .name{
      font-size: 16px;
      font-weight: 950;
      letter-spacing: 0.2px;
      line-height: 1.15;
    }
    .mv{
      font-size: 13px;
      color: var(--muted);
      white-space: nowrap;
      font-weight: 850;
    }

    .imgFrame{
      border-radius: var(--radius-lg);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      box-shadow: var(--shadow);
      /* Keep it within iPhone screen */
      max-height: 70svh;
      aspect-ratio: 63 / 88; /* MTG-ish ratio */
    }

    img{
      width: 100%;
      height: 100%;
      display:block;
      object-fit: contain;
      transform-origin: 50% 60%;
    }

    /* Reveal animation */
    .reveal{
      animation: reveal 720ms cubic-bezier(.16,.84,.27,1) both;
    }
    @keyframes reveal{
      0%{
        opacity:0;
        transform: scale(0.86) rotate(-2deg);
        filter: blur(16px) brightness(0.75);
      }
      60%{
        opacity:1;
        transform: scale(1.02) rotate(0.4deg);
        filter: blur(2px) brightness(1);
      }
      100%{
        opacity:1;
        transform: scale(1) rotate(0deg);
        filter:none;
      }
    }

    /* Loading shimmer */
    .loadingFrame{
      position: relative;
      width: 100%;
      height: 100%;
      min-height: 320px;
    }
    .loadingFrame::before{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(110deg,
        rgba(255,255,255,0.02),
        rgba(255,255,255,0.10),
        rgba(255,255,255,0.02)
      );
      transform: translateX(-60%);
      animation: shimmer 1.15s ease-in-out infinite;
    }
    @keyframes shimmer{
      0%   { transform: translateX(-60%); opacity: 0.55; }
      50%  { opacity: 0.95; }
      100% { transform: translateX(60%);  opacity: 0.55; }
    }

    .status{
      font-size: 13px;
      color: var(--muted);
      line-height: 1.35;
    }

    a{
      color: rgba(140,174,248,0.98);
      text-decoration:none;
      font-weight: 900;
    }

    @media (prefers-reduced-motion: reduce){
      .overlay, .stage { transition: none; }
      .reveal { animation: none; }
      .loadingFrame::before { animation: none; }
    }

    /* Small phones: tighten spacing a bit */
    @media (max-height: 720px){
      .grid button{ height: 66px; }
      .imgFrame{ max-height: 66svh; }
      .title{ font-size: 20px; }
    }

    /* ---------- History (bottom glass tab + sheet) ---------- */
    .historyTab{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(12px + env(safe-area-inset-bottom));
      z-index: 12; /* above overlay */
      padding: 10px 16px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(10px);
      color: var(--text);
      font-weight: 900;
      font-size: 13px;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
    }
    .historyTab:active{
      transform: translateX(-50%) scale(0.98);
      background: rgba(255,255,255,0.10);
      border-color: var(--stroke2);
    }

    .historySheet{
      position: fixed;
      inset: 0;
      z-index: 30;
      pointer-events: none;
    }
    .historySheet.open{
      pointer-events: auto;
    }

    .historyBackdrop{
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.55);
      opacity: 0;
      transition: opacity 220ms ease;
    }
    .historySheet.open .historyBackdrop{
      opacity: 1;
    }

    .historyPanel{
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(14px);
      box-shadow: 0 -18px 60px rgba(0,0,0,0.55);
      transform: translateY(110%);
      transition: transform 260ms cubic-bezier(.2,.9,.2,1);
      max-height: 86svh;
      display: flex;
      flex-direction: column;
    }
    .historySheet.open .historyPanel{
      transform: translateY(0);
    }

    .historyHeader{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding:
        14px
        calc(14px + env(safe-area-inset-right))
        10px
        calc(14px + env(safe-area-inset-left));
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }
    .historyTitle{
      font-weight: 950;
      letter-spacing: 0.2px;
      font-size: 14px;
      color: var(--text);
    }
    .historyClose{
      padding: 9px 12px;
      border-radius: 999px;
      font-size: 13px;
    }

    .historyList{
      padding:
        12px
        calc(14px + env(safe-area-inset-right))
        calc(14px + env(safe-area-inset-bottom))
        calc(14px + env(safe-area-inset-left));
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .historyEmpty{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
      padding: 14px 6px;
      text-align: center;
    }

    .historyCard{
      appearance: none;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 14px 32px rgba(0,0,0,0.35);
      padding: 0;
      text-align: left;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    .historyCard:active{
      transform: scale(0.99);
      border-color: rgba(255,255,255,0.20);
      background: rgba(255,255,255,0.08);
    }

    .historyCard img{
      width: 100%;
      height: auto;
      display: block;
      object-fit: contain;
      background: rgba(0,0,0,0.18);
    }

    .historyMeta{
      display: flex;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px 12px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.25;
      border-top: 1px solid rgba(255,255,255,0.08);
    }
    .historyMeta b{
      color: var(--text);
      font-weight: 900;
    }
  </style>
</head>

<body>
  <!-- Full-screen number overlay -->
  <section id="overlay" class="overlay safePad" aria-label="CMC number overlay">
    <div class="header">
      <h1 class="title">Choose a CMC to Summon</h1>
      <p class="subtitle">Tap 1–20 to pull a random creature with that mana value.</p>
      <p class="hint"><span class="warnWord">Red-tinted</span> numbers have no matching creatures.</p>
    </div>

    <div id="cmcGrid" class="grid" role="group" aria-label="CMC buttons"></div>

    <div class="footerNote">Tip: tap anywhere on the card to return to numbers.</div>
  </section>

  <!-- Bottom glass tab (home only) -->
  <button id="historyTab" class="historyTab" type="button" aria-label="Open history">History</button>

  <!-- History sheet -->
  <section id="historySheet" class="historySheet" aria-label="History">
    <div id="historyBackdrop" class="historyBackdrop"></div>
    <div class="historyPanel">
      <div class="historyHeader">
        <div class="historyTitle">History</div>
        <button id="historyClose" class="btn historyClose" type="button">Close</button>
      </div>
      <div id="historyList" class="historyList"></div>
    </div>
  </section>

  <!-- Card stage -->
  <main id="stage" class="stage safePad" aria-live="polite">
    <div class="panel">
      <div class="topbar">
        <button id="backBtn" class="btn" type="button">Pick another</button>
        <div id="cmcPill" class="pill">CMC: —</div>
      </div>

      <div class="cardWrap">
        <div class="meta">
          <div id="cardName" class="name">Waiting…</div>
          <div id="cardMV" class="mv"></div>
        </div>

        <div class="imgFrame" id="frame">
          <div id="loadingShell" class="loadingFrame" style="display:none;"></div>
          <img id="cardImg" alt="" />
        </div>

        <div id="statusLine" class="status"></div>
        <div class="status">
          <a id="scryfallLink" href="#" target="_blank" rel="noopener noreferrer" style="display:none;">
            View on Scryfall
          </a>
        </div>
      </div>
    </div>
  </main>

  <script>
    // ---------------------------
    // Scryfall query
    // Front-face Creature only:
    // t:/^[^\/]*Creature/
    // (prevents Battles/Enchantments/etc that transform into creatures)
    // ---------------------------

    const SCRYFALL_RANDOM = "https://api.scryfall.com/cards/random";
    const SCRYFALL_SEARCH = "https://api.scryfall.com/cards/search";

    // Keep your original filters, but build as plain text then URLSearchParams encodes safely.
    const BASE_QUERY = 't:/^[^\\/]*Creature/ (game:paper) lang:english (-is:funny) is:firstprinting F:V -o:draft';

    let inFlight = false;
    let buttonsByMV = {};

    // Cache availability checks to avoid 20 API hits on every load (24h TTL)
    const AVAIL_CACHE_KEY = "mvCreatureAvailability_v1";
    const AVAIL_CACHE_TTL_MS = 24 * 60 * 60 * 1000;

    // History (local only)
    const HISTORY_KEY = "creatureHistory_v1";
    const HISTORY_MAX = 15;

    // returnMode:
    // "overlay"  -> tap stage returns to numbers
    // "history"  -> tap stage returns to history sheet
    let returnMode = "overlay";

    function $(id){ return document.getElementById(id); }

    function buildRandomUrl(mv){
      const q = `${BASE_QUERY} mv=${mv}`;
      const u = new URL(SCRYFALL_RANDOM);
      u.searchParams.set("format", "json");
      u.searchParams.set("q", q);
      u.searchParams.set("t", String(Date.now()));
      return u.toString();
    }

    function buildSearchUrl(mv){
      const q = `${BASE_QUERY} mv=${mv}`;
      const u = new URL(SCRYFALL_SEARCH);
      u.searchParams.set("order", "released");
      u.searchParams.set("unique", "cards");
      u.searchParams.set("q", q);
      u.searchParams.set("t", String(Date.now()));
      return u.toString();
    }

    // ✅ Shows useful "no results" messages by reading Scryfall's error JSON
    async function fetchNewCard(url) {
      const response = await fetch(url);

      const text = await response.text();
      let data = null;
      try { data = JSON.parse(text); } catch {}

      if (!response.ok) {
        throw new Error(data?.details ?? `Scryfall error: ${response.status}`);
      }
      return data;
    }

    // Handles single-faced and multi-faced cards
    function getImageUrl(card) {
      if (card?.image_uris?.border_crop) return card.image_uris.border_crop;

      const face = card?.card_faces?.find(f => f?.image_uris?.border_crop);
      if (face) return face.image_uris.border_crop;

      // fallbacks
      if (card?.image_uris?.normal) return card.image_uris.normal;
      const face2 = card?.card_faces?.find(f => f?.image_uris?.normal);
      if (face2) return face2.image_uris.normal;

      return "";
    }

    /* ---------- History helpers ---------- */

    function loadHistory(){
      try {
        const arr = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
        return Array.isArray(arr) ? arr : [];
      } catch {
        return [];
      }
    }

    function saveHistory(arr){
      try {
        localStorage.setItem(HISTORY_KEY, JSON.stringify(arr));
      } catch {}
    }

    function addToHistory(card, chosenMV){
      const img = getImageUrl(card);
      const uri = card?.scryfall_uri || "";
      const name = card?.name || "Unknown card";
      const mvVal = (card?.mana_value ?? card?.cmc ?? chosenMV);

      const entry = {
        ts: Date.now(),
        chosenMV,
        mvVal,
        name,
        img,
        uri
      };

      let hist = loadHistory();

      // de-dupe by (uri) if present, else by name+mv
      hist = hist.filter(h => {
        if (entry.uri && h.uri) return h.uri !== entry.uri;
        return !(h.name === entry.name && h.chosenMV === entry.chosenMV && h.mvVal === entry.mvVal);
      });

      hist.unshift(entry);
      if (hist.length > HISTORY_MAX) hist = hist.slice(0, HISTORY_MAX);

      saveHistory(hist);
    }

    function renderHistory(){
      const list = $("historyList");
      const hist = loadHistory();

      list.innerHTML = "";

      if (!hist.length){
        const empty = document.createElement("div");
        empty.className = "historyEmpty";
        empty.textContent = "No history yet — summon a creature first.";
        list.appendChild(empty);
        return;
      }

      for (const entry of hist){
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "historyCard";

        // Tap history card -> show full card in app, then tap anywhere returns to history.
        btn.addEventListener("click", () => showHistoryCard(entry));

        const img = document.createElement("img");
        img.loading = "lazy";
        img.alt = entry.name;
        if (entry.img) img.src = entry.img;

        const meta = document.createElement("div");
        meta.className = "historyMeta";
        meta.innerHTML = `<div><b>${escapeHtml(entry.name)}</b></div><div>CMC ${entry.chosenMV}</div>`;

        btn.appendChild(img);
        btn.appendChild(meta);
        list.appendChild(btn);
      }
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function openHistory(){
      renderHistory();
      $("historySheet").classList.add("open");
    }

    function closeHistory(){
      $("historySheet").classList.remove("open");
    }

    function returnToHistory(){
      showOverlay();
      openHistory();
    }

    function showHistoryCard(entry){
      returnMode = "history";
      closeHistory();
      showStage();

      const status = $("statusLine");
      const img = $("cardImg");
      const nameEl = $("cardName");
      const mvEl = $("cardMV");
      const linkEl = $("scryfallLink");
      const cmcPill = $("cmcPill");
      const loadingShell = $("loadingShell");

      cmcPill.textContent = "CMC: " + entry.chosenMV;
      nameEl.textContent = entry.name || "Unknown card";
      mvEl.textContent = (entry.mvVal != null) ? ("MV " + entry.mvVal) : "";
      status.textContent = "Tap anywhere to return to history.";

      loadingShell.style.display = "none";
      img.classList.remove("reveal");
      img.onload = null;
      img.removeAttribute("src");
      img.alt = "";

      if (entry.uri) {
        linkEl.href = entry.uri;
        linkEl.style.display = "inline";
      } else {
        linkEl.style.display = "none";
      }

      if (entry.img) {
        img.onload = () => { void img.offsetWidth; img.classList.add("reveal"); };
        img.src = entry.img;
        img.alt = entry.name || "MTG card";
      }
    }

    /* ---------- Auto-style buttons (no results) ---------- */

    function createLimiter(maxConcurrent) {
      let active = 0;
      const queue = [];
      return (fn) => new Promise((resolve, reject) => {
        const run = async () => {
          active++;
          try { resolve(await fn()); }
          catch (e) { reject(e); }
          finally {
            active--;
            if (queue.length) queue.shift()();
          }
        };
        if (active < maxConcurrent) run();
        else queue.push(run);
      });
    }
    const limit = createLimiter(4);

    // Returns: true (has results), false (no results), null (unknown/error)
    async function hasCreatureForMV(mv) {
      const url = buildSearchUrl(mv);
      const res = await fetch(url);

      // /cards/search returns 404 when nothing matches
      if (res.status === 404) return false;
      if (!res.ok) return null;

      const data = await res.json().catch(() => null);
      const total = data?.total_cards;
      if (typeof total === "number") return total > 0;

      return Array.isArray(data?.data) && data.data.length > 0;
    }

    function applyNoResultStyles(availabilityMap) {
      for (const [mvStr, btn] of Object.entries(buttonsByMV)) {
        const mv = Number(mvStr);
        const available = availabilityMap[mv];
        if (available === false) btn.classList.add("noResult");
        else btn.classList.remove("noResult");
      }
    }

    async function refreshNoResultButtons() {
      const now = Date.now();

      // 1) Try cache
      try {
        const cached = JSON.parse(localStorage.getItem(AVAIL_CACHE_KEY) || "null");
        if (cached?.timestamp && cached?.map && (now - cached.timestamp) < AVAIL_CACHE_TTL_MS) {
          applyNoResultStyles(cached.map);
          return;
        }
      } catch {}

      // 2) Live check
      const map = {};
      const mvs = Object.keys(buttonsByMV).map(Number);

      await Promise.all(
        mvs.map(mv => limit(async () => {
          try { map[mv] = await hasCreatureForMV(mv); }
          catch { map[mv] = null; } // don't tint on network issues
        }))
      );

      applyNoResultStyles(map);

      // 3) Store cache
      try {
        localStorage.setItem(AVAIL_CACHE_KEY, JSON.stringify({ timestamp: now, map }));
      } catch {}
    }

    /* ---------- UI transitions ---------- */

    function showOverlay() {
      $("overlay").classList.remove("hidden");
      $("stage").classList.remove("visible");
      $("statusLine").textContent = "";
      returnMode = "overlay";
      refreshNoResultButtons(); // uses cache; won’t spam
    }

    function showStage() {
      $("overlay").classList.add("hidden");
      $("stage").classList.add("visible");
    }

    /* ---------- Summon flow ---------- */

    async function summonCreature(mv) {
      if (inFlight) return;
      inFlight = true;
      returnMode = "overlay";

      const status = $("statusLine");
      const img = $("cardImg");
      const nameEl = $("cardName");
      const mvEl = $("cardMV");
      const linkEl = $("scryfallLink");
      const cmcPill = $("cmcPill");
      const loadingShell = $("loadingShell");

      closeHistory(); // in case it's open
      showStage();

      cmcPill.textContent = "CMC: " + mv;
      nameEl.textContent = "Summoning…";
      mvEl.textContent = "";
      linkEl.style.display = "none";
      status.textContent = "Searching for a creature with MV " + mv + "…";

      img.classList.remove("reveal");
      img.onload = null;
      img.removeAttribute("src");
      img.alt = "";

      loadingShell.style.display = "block";

      try {
        const card = await fetchNewCard(buildRandomUrl(mv));
        const imageUrl = getImageUrl(card);
        const displayedMV = (card?.mana_value ?? card?.cmc);

        nameEl.textContent = card?.name ?? "Unknown card";
        mvEl.textContent = (displayedMV != null) ? ("MV " + displayedMV) : "";

        if (card?.scryfall_uri) {
          linkEl.href = card.scryfall_uri;
          linkEl.style.display = "inline";
        }

        // add to local history (device only)
        addToHistory(card, mv);

        if (!imageUrl) {
          loadingShell.style.display = "none";
          status.textContent = "Pulled: " + (card?.name ?? "Unknown") + " (no image for this layout)";
          return;
        }

        img.onload = () => {
          loadingShell.style.display = "none";
          void img.offsetWidth; // retrigger animation
          img.classList.add("reveal");
        };

        img.src = imageUrl;
        img.alt = card?.name ?? "MTG card";
        status.textContent = "Pulled: " + (card?.name ?? "Unknown") + " — tap anywhere to return.";
      } catch (err) {
        loadingShell.style.display = "none";
        nameEl.textContent = "No card found";
        mvEl.textContent = "";
        status.textContent = "No result: " + (err?.message ?? String(err)) + " — try another number.";
      } finally {
        inFlight = false;
      }
    }

    /* ---------- Tap-anywhere behavior on stage ---------- */

    function handleStageTap(ev){
      // Don’t hijack taps on controls/links
      if (ev.target.closest("button, a")) return;
      if (!$("stage").classList.contains("visible")) return;

      if (returnMode === "history") {
        returnToHistory();
      } else {
        showOverlay();
      }
    }

    function init() {
      const grid = $("cmcGrid");
      const backBtn = $("backBtn");

      buttonsByMV = {};

      for (let i = 1; i <= 20; i++) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = String(i);
        btn.addEventListener("click", () => summonCreature(i));
        grid.appendChild(btn);
        buttonsByMV[i] = btn;
      }

      // back button:
      // - normal pulls: go to overlay
      // - history preview: go back to history
      backBtn.addEventListener("click", () => {
        if (returnMode === "history") returnToHistory();
        else showOverlay();
      });

      // tap anywhere on stage to return (overlay or history)
      $("stage").addEventListener("click", handleStageTap);

      // history tab + sheet wiring
      $("historyTab").addEventListener("click", openHistory);
      $("historyClose").addEventListener("click", closeHistory);
      $("historyBackdrop").addEventListener("click", closeHistory);

      showOverlay();
      refreshNoResultButtons();
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
